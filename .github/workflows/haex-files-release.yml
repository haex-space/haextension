name: haex-files Release

on:
  push:
    tags:
      - 'haex-files-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (without v prefix, e.g., 0.1.0)'
        required: false
        type: string

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Prepare dependencies
        run: |
          cd packages/haex-ui && npx nuxt prepare && cd ../..
          pnpm --filter haex-files exec nuxt prepare

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/haex-files-v}" >> $GITHUB_OUTPUT
          fi

      - name: Setup signing keys
        run: |
          mkdir -p apps/haex-files/haextension
          echo "${{ secrets.HAEX_FILES_PRIVATE_KEY }}" > apps/haex-files/haextension/private.key
          echo "${{ secrets.HAEX_FILES_PUBLIC_KEY }}" > apps/haex-files/haextension/public.key

      - name: Build extension
        run: pnpm --filter haex-files build:release

      - name: Find bundle file
        id: bundle
        run: |
          BUNDLE_PATH=$(find apps/haex-files -name "*.xt" -type f | head -1)
          if [ -z "$BUNDLE_PATH" ]; then
            echo "No .xt bundle found!"
            exit 1
          fi
          echo "path=$BUNDLE_PATH" >> $GITHUB_OUTPUT
          echo "Found bundle: $BUNDLE_PATH"

      - name: Upload to marketplace
        env:
          MARKETPLACE_API_KEY: ${{ secrets.MARKETPLACE_API_KEY }}
          MARKETPLACE_API: https://marketplace.haex.space
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUNDLE_PATH="${{ steps.bundle.outputs.path }}"
          MANIFEST_PATH="apps/haex-files/haextension/manifest.json"

          echo "Uploading version $VERSION to marketplace..."

          curl -X POST "${MARKETPLACE_API}/publish/extensions/haex-files/bundle" \
            -H "Authorization: Bearer ${MARKETPLACE_API_KEY}" \
            -F "bundle=@${BUNDLE_PATH}" \
            -F "version=${VERSION}" \
            -F "manifest=<${MANIFEST_PATH}" \
            --fail-with-body

          echo "Successfully uploaded to marketplace"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: haex-files-${{ steps.version.outputs.version }}
          path: ${{ steps.bundle.outputs.path }}
          retention-days: 90

  github-release:
    needs: build-and-upload
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: haex-files-${{ needs.build-and-upload.outputs.version }}

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/haex-files-v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: haex-files-v${{ steps.version.outputs.version }}
          name: haex-files v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            *.xt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
